<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OVA 1: Daily Activities Vocabulary</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    body{font-family:'Poppins',sans-serif}
    
    /* Estilos para el sidebar est√°tico */
    .sticky-sidebar {
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      z-index: 10;
    }
    
    /* Scrollbar personalizado para el sidebar */
    .sticky-sidebar::-webkit-scrollbar {
      width: 6px;
    }
    
    .sticky-sidebar::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    
    .sticky-sidebar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    
    .sticky-sidebar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    .sidebar-link{transition:all .3s ease;border-left:4px solid transparent}
    .sidebar-link.active,.sidebar-link:hover{background:#e6f4ea;color:#166534;border-left-color:#22c55e}
    .content-pane{display:none;animation:fadeIn .5s ease-in-out}
    .content-pane.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .quiz-option:hover{background:#f0fdf4}
    .quiz-option.selected{background:#dcfce7;border-color:#22c55e}
    .drag-item{cursor:grab}
    .drop-zone{min-height:48px}
    .drop-zone.filled{background:#ecfdf5}
    .sortable-token{cursor:grab}
    .token-bin{min-height:52px}
    .speak-btn{transition:transform .08s ease}
    .speak-btn:active{transform:scale(.92)}
    .pill{border:1px dashed #86efac}
    .tag{border:1px solid #d1fae5}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    
    /* Estilos para el grabador de audio */
    .recording-indicator {
      animation: pulse 1.5s ease-in-out infinite alternate;
    }
    
    @keyframes pulse {
      from { opacity: 1; }
      to { opacity: 0.5; }
    }
    
    .audio-player {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border: 1px solid #bbf7d0;
    }
    
    .recording-timer {
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.05em;
    }
  </style>
</head>
<body class="bg-slate-50">

<div class="flex min-h-screen">
  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-lg flex-shrink-0 hidden md:flex md:flex-col sticky-sidebar">
    <div class="p-4">
      <div style="width: 150px; height: 150px;" class="p-2 mx-auto flex items-center justify-center bg-white rounded-full shadow-lg border-2 border-green-500 transition-shadow duration-300 hover:shadow-green-400">
          <img src="img/logo.webp" alt="Logo OVA" class="w-5/6 h-5/6 object-contain" loading="lazy">
      </div>
  </div>
    <nav class="mt-6 flex-1">
      <a href="#" class="sidebar-link active flex items-center py-3 px-6 font-medium text-slate-700" data-target="introduccion"><span class="mr-3 text-xl">üöÄ</span> Introducci√≥n</a>
      <a href="#" class="sidebar-link flex items-center py-3 px-6 font-medium text-slate-700" data-target="objetivos"><span class="mr-3 text-xl">üéØ</span> Objetivos</a>
      <a href="#" class="sidebar-link flex items-center py-3 px-6 font-medium text-slate-700" data-target="contenido"><span class="mr-3 text-xl">üìö</span> Contenido</a>
      <a href="#" class="sidebar-link flex items-center py-3 px-6 font-medium text-slate-700" data-target="actividades"><span class="mr-3 text-xl">‚úçÔ∏è</span> Actividades</a>
      <a href="#" class="sidebar-link flex items-center py-3 px-6 font-medium text-slate-700" data-target="evaluacion"><span class="mr-3 text-xl">‚úîÔ∏è</span> Evaluaci√≥n</a>
      <a href="#" class="sidebar-link flex items-center py-3 px-6 font-medium text-slate-700" data-target="recursos"><span class="mr-3 text-xl">üìñ</span> Recursos</a>
      <a href="#" class="sidebar-link flex items-center py-3 px-6 font-medium text-slate-700" data-target="bibliografia"><span class="mr-3 text-xl">üìö</span> Bibliograf√≠a</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-4 sm:p-6 md:p-10 bg-gray-50">
    <!-- Mobile header -->
    <div class="md:hidden mb-6">
      <select id="mobile-nav" class="w-full p-2 border rounded-md bg-white shadow-sm">
        <option value="introduccion">üöÄ Introducci√≥n</option>
        <option value="objetivos">üéØ Objetivos</option>
        <option value="contenido">üìö Contenido</option>
        <option value="actividades">‚úçÔ∏è Actividades</option>
        <option value="evaluacion">‚úîÔ∏è Evaluaci√≥n</option>
        <option value="recursos">üìñ Recursos</option>
        <option value="bibliografia">üìö Bibliograf√≠a</option>
      </select>
    </div>

    <!-- Introducci√≥n -->
    <section id="introduccion" class="content-pane active">
      <h2 class="text-2xl sm:text-3xl font-bold text-green-800 mb-4">Daily Activities Vocabulary</h2>
      <p class="text-slate-700 leading-relaxed mb-4">
        üëã ¬°Bienvenido! En este OVA aprender√°s el vocabulario esencial para hablar de tu <b>rutina diaria</b> en ingl√©s. Est√°
        pensado para tu realidad como estudiante de <b>T√©cnico Profesional en Programaci√≥n Web</b> en <b>Monter√≠a, Lorica,
        Sahag√∫n, Ber√°stegui y Montel√≠bano</b>: madrugar, ir al campus o conectarte, programar, revisar correos, practicar
        deporte y compartir en familia.
      </p>
      <div class="p-4 sm:p-6 bg-green-50 border-l-4 border-green-500 rounded-r-lg text-green-900">
        üí° <b>¬øPor qu√© es importante?</b> El ingl√©s es el idioma com√∫n de la tecnolog√≠a. Saber describir lo que haces cada d√≠a
        te ayudar√° a presentarte en equipos, coordinar tareas y aprender de documentaci√≥n t√©cnica. Aqu√≠ todo es
        <b>interactivo</b>: escuchar√°s la pronunciaci√≥n, arrastrar√°s palabras, completar√°s oraciones, ordenar√°s frases y hasta podr√°s
        <b>grabar tu rutina</b>. 
      </div>
      <p class="mt-4 text-slate-600 text-sm">
        Consejo: si ves el √≠cono üîä toca para escuchar la pronunciaci√≥n (usa el altavoz de tu dispositivo).
      </p>
    </section>

    <!-- Objetivos -->
    <section id="objetivos" class="content-pane">
      <h2 class="text-2xl sm:text-3xl font-bold text-green-800 mb-6">Objetivos de aprendizaje</h2>
      <ul class="space-y-4">
        <li class="flex items-start p-4 bg-white rounded-lg shadow-sm"><span class="mr-3 text-2xl text-green-700">üß†</span><span>Reconocer y pronunciar correctamente el vocabulario de actividades diarias.</span></li>
        <li class="flex items-start p-4 bg-white rounded-lg shadow-sm"><span class="mr-3 text-2xl text-green-700">üó£Ô∏è</span><span>Usar el vocabulario en frases simples para describir tu rutina personal y acad√©mica.</span></li>
        <li class="flex items-start p-4 bg-white rounded-lg shadow-sm"><span class="mr-3 text-2xl text-green-700">üß©</span><span>Resolver actividades interactivas (drag & drop, cloze, ordenar, quiz) con retroalimentaci√≥n inmediata.</span></li>
        <li class="flex items-start p-4 bg-white rounded-lg shadow-sm"><span class="mr-3 text-2xl text-green-700">üéôÔ∏è</span><span>Producir un audio corto describiendo tu rutina diaria en ingl√©s.</span></li>
      </ul>
    </section>

    <!-- Contenido -->
    <section id="contenido" class="content-pane">
      <h2 class="text-2xl sm:text-3xl font-bold text-green-800 mb-6">Contenido</h2>

      <!-- Vocab list with TTS -->
      <div class="mb-6">
        <h3 class="text-xl font-bold text-green-700 mb-2">Vocabulario clave</h3>
        <p class="text-slate-600 mb-4">Toca üîä para escuchar.</p>
        <div id="vocab-grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>

      <!-- Micro quiz -->
      <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-sm p-4 sm:p-6">
        <h4 class="text-lg font-bold text-green-700 mb-2">Chequeo r√°pido</h4>
        <p class="text-slate-600 mb-3">Selecciona la opci√≥n correcta.</p>
        <div id="micro-quiz" class="space-y-3"></div>
        <button id="micro-quiz-btn" class="mt-4 bg-green-600 text-white font-semibold py-2 px-4 rounded hover:bg-green-700">Comprobar</button>
        <div id="micro-quiz-res" class="mt-3 font-medium"></div>
      </div>
    </section>

    <!-- Actividades -->
    <section id="actividades" class="content-pane">
      <h2 class="text-2xl sm:text-3xl font-bold text-green-800 mb-6">Actividades</h2>

      <!-- Drag & Drop Matching -->
      <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-sm p-6 mb-6">
        <h3 class="text-xl font-bold text-green-700 mb-2">1) Empareja: Ingl√©s ‚Üî Espa√±ol</h3>
        <p class="text-slate-600 mb-4">Arrastra cada palabra en ingl√©s hacia su traducci√≥n correcta.</p>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <h4 class="font-semibold mb-2">Palabras (arrastra)</h4>
            <div id="drag-bank" class="grid grid-cols-2 gap-2"></div>
          </div>
          <div>
            <h4 class="font-semibold mb-2">Traducciones (suelta aqu√≠)</h4>
            <div id="drop-bank" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
          </div>
        </div>
        <button id="check-matching" class="mt-4 bg-green-600 text-white font-semibold py-2 px-4 rounded hover:bg-green-700">Verificar</button>
        <div id="matching-result" class="mt-3 font-medium"></div>
      </div>

      <!-- Cloze (fill in blanks) -->
      <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-sm p-6 mb-6">
        <h3 class="text-xl font-bold text-green-700 mb-2">2) Completa las frases</h3>
        <p class="text-slate-600 mb-3">Usa estas palabras: <span class="tag inline-block px-2 py-1 rounded bg-green-50 text-green-700">wake up</span> <span class="tag inline-block px-2 py-1 rounded bg-green-50 text-green-700">have breakfast</span> <span class="tag inline-block px-2 py-1 rounded bg-green-50 text-green-700">go to class</span> <span class="tag inline-block px-2 py-1 rounded bg-green-50 text-green-700">study programming</span> <span class="tag inline-block px-2 py-1 rounded bg-green-50 text-green-700">check email</span></p>
        <div id="cloze-list" class="space-y-3"></div>
        <button id="check-cloze" class="mt-4 bg-green-600 text-white font-semibold py-2 px-4 rounded hover:bg-green-700">Comprobar</button>
        <div id="cloze-result" class="mt-3 font-medium"></div>
      </div>

      <!-- Ordering tokens -->
      <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-sm p-6 mb-6">
        <h3 class="text-xl font-bold text-green-700 mb-2">3) Ordena la oraci√≥n</h3>
        <p class="text-slate-600 mb-3">Arrastra las palabras para formar una oraci√≥n correcta.</p>
        <div id="order-list" class="space-y-4"></div>
        <button id="check-order" class="mt-4 bg-green-600 text-white font-semibold py-2 px-4 rounded hover:bg-green-700">Comprobar</button>
        <div id="order-result" class="mt-3 font-medium"></div>
      </div>

      <!-- Speaking / Recording -->
      <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-sm p-6">
        <h3 class="text-xl font-bold text-green-700 mb-2">4) Speaking: graba tu rutina</h3>
        <p class="text-slate-600 mb-3">Graba un audio (30‚Äì60 s) diciendo al menos 5 actividades. Ejemplo: <i>I wake up at 6, I have breakfast, I go to class, I study programming and I check my email at night.</i></p>
        
        <!-- Controles de grabaci√≥n -->
        <div class="flex items-center gap-3 mb-4">
          <button id="rec-start" class="bg-green-600 text-white font-semibold py-2 px-4 rounded hover:bg-green-700 transition-colors">
            üéôÔ∏è Iniciar
          </button>
          <button id="rec-stop" class="bg-red-600 text-white font-semibold py-2 px-4 rounded hover:bg-red-700 transition-colors" disabled>
            ‚èπÔ∏è Detener
          </button>
        </div>
        
        <!-- Estado y temporizador -->
        <div class="flex items-center gap-4 mb-4">
          <span id="rec-status" class="text-slate-600 font-medium">Listo para grabar</span>
          <div id="rec-timer" class="hidden text-lg font-mono text-green-700 bg-green-50 px-3 py-1 rounded recording-timer">
            <span id="rec-time">00:00</span>
          </div>
        </div>
        
        <!-- Indicador visual de grabaci√≥n -->
        <div id="rec-indicator" class="hidden mb-4">
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-red-500 rounded-full recording-indicator"></div>
            <span class="text-red-600 font-medium">Grabando...</span>
          </div>
        </div>
        
                 <!-- √Årea de audio grabado -->
         <div id="rec-audio" class="mt-4"></div>
         
         <!-- Bot√≥n de verificaci√≥n -->
         <div id="verification-section" class="mt-4 hidden">
           <button id="verify-audio" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded hover:bg-blue-700 transition-colors">
             üîç Verificar cumplimiento de criterios
           </button>
           <div id="verification-result" class="mt-3"></div>
         </div>
        
                 <!-- Instrucciones adicionales -->
         <div class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-400 rounded-r text-blue-800 text-sm">
           üí° <strong>Consejos:</strong> Habla claramente, menciona al menos 5 actividades de tu rutina diaria, y usa frases completas en ingl√©s.
         </div>
         
         <!-- Criterios de evaluaci√≥n -->
         <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-r text-yellow-800 text-sm">
           üìã <strong>Criterios de evaluaci√≥n:</strong>
           <ul class="mt-2 space-y-1 text-xs">
             <li>‚Ä¢ Duraci√≥n: 30-60 segundos</li>
             <li>‚Ä¢ Calidad: Audio claro sin silencios prolongados</li>
             <li>‚Ä¢ Contenido: M√≠nimo 5 actividades del vocabulario</li>
             <li>‚Ä¢ Idioma: Frases en ingl√©s</li>
             <li>‚Ä¢ Estructura: Oraciones completas con sujeto + verbo</li>
           </ul>
         </div>
      </div>
    </section>

    <!-- Evaluaci√≥n -->
    <section id="evaluacion" class="content-pane">
      <h2 class="text-2xl sm:text-3xl font-bold text-green-800 mb-6">Evaluaci√≥n</h2>
      <div class="bg-white p-6 rounded-lg shadow-md">
        <p class="text-slate-600 mb-4">Responde todas las preguntas. Recibir√°s retroalimentaci√≥n inmediata.</p>
        <div id="quiz-container" class="space-y-6"></div>
        <button id="submit-quiz-btn" class="mt-2 bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Finalizar evaluaci√≥n</button>
        <button id="reset-quiz-btn" class="mt-2 ml-2 bg-slate-100 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-200">Reintentar</button>
        <div id="quiz-result" class="mt-4 text-lg font-bold"></div>
      </div>
    </section>

    <!-- Recursos -->
    <section id="recursos" class="content-pane">
      <h2 class="text-2xl sm:text-3xl font-bold text-green-800 mb-6">Recursos para profundizar</h2>
      <ul class="space-y-4">
        <li class="bg-white p-4 rounded-lg shadow-md border-l-4 border-green-500">
          <h3 class="font-bold text-green-700">British Council ‚Äì Daily routines</h3>
          <a class="underline text-slate-700 hover:text-green-700" href="https://learnenglish.britishcouncil.org/grammar/a1-a2-grammar/present-simple" target="_blank">Ir al recurso</a>
        </li>
        <li class="bg-white p-4 rounded-lg shadow-md border-l-4 border-green-500">
          <h3 class="font-bold text-green-700">Quizlet (tarjetas) ‚Äì Daily routines</h3>
          <a class="underline text-slate-700 hover:text-green-700" href="https://quizlet.com/subject/daily-routines/" target="_blank">Ir al recurso</a>
        </li>
        <li class="bg-white p-4 rounded-lg shadow-md border-l-4 border-green-500">
          <h3 class="font-bold text-green-700">Kahoot ‚Äì Daily routines</h3>
          <a class="underline text-slate-700 hover:text-green-700" href="https://kahoot.com/schools-u/" target="_blank">Ir al recurso</a>
        </li>
        <li class="bg-white p-4 rounded-lg shadow-md border-l-4 border-green-500">
          <h3 class="font-bold text-green-700">YouGlish (pronunciaci√≥n por contexto)</h3>
          <a class="underline text-slate-700 hover:text-green-700" href="https://youglish.com/" target="_blank">Ir al recurso</a>
        </li>
      </ul>
    </section>

    <!-- Bibliograf√≠a -->
    <section id="bibliografia" class="content-pane">
      <h2 class="text-2xl sm:text-3xl font-bold text-green-800 mb-6">Bibliograf√≠a</h2>
      <div class="space-y-6">
        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500">
          <span class="block text-slate-700">Flores Kastanis, P. (2016). <i>English 1</i> (2.¬™ ed.). Grupo Editorial Patria.</span>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500">
          <span class="block text-slate-700">Pulido M√©ndez, P. (2022). <i>Comunicaci√≥n en lenguas extranjeras (ingl√©s) N2: FCOV05</i>. Editorial Tutor Formaci√≥n.</span>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500">
          <span class="block text-slate-700">British Council. (2023). <i>Learn English: Daily Routines</i>. https://learnenglish.britishcouncil.org</span>
        </div>
      </div>

      <footer class="mt-12 pt-6 border-t-2 border-slate-200 text-center">
        <p class="text-slate-600 font-medium">Creado para estudiantes de T√©cnico Profesional en Programaci√≥n Web</p>
        <p class="text-green-800 font-bold text-lg">Universidad de C√≥rdoba ‚Äî Monter√≠a, Lorica, Sahag√∫n, Ber√°stegui, Montel√≠bano</p>
      </footer>
    </section>
  </main>
</div>

<script>
/* ===== Navegaci√≥n panes ===== */
document.addEventListener('DOMContentLoaded', () => {
  const links = document.querySelectorAll('.sidebar-link');
  const panes = document.querySelectorAll('.content-pane');
  const mobile = document.getElementById('mobile-nav');

  function switchPane(id){
    panes.forEach(p=>p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    links.forEach(l=>l.classList.toggle('active', l.dataset.target===id));
    if(mobile && mobile.value!==id) mobile.value=id;
  }
  links.forEach(l=>l.addEventListener('click', e=>{
    e.preventDefault();
    switchPane(l.dataset.target);
  }));
  mobile && mobile.addEventListener('change', e=>switchPane(e.target.value));
});

/* ===== TTS helper ===== */
function speak(text){
  try{
    const u=new SpeechSynthesisUtterance(text);
    u.lang='en-US';
    speechSynthesis.speak(u);
  }catch(e){
    alert('Tu navegador no permite pronunciaci√≥n autom√°tica.');
  }
}

/* ===== Vocabulario con TTS ===== */
const VOCAB = [
  {en:'wake up', es:'despertarse'},
  {en:'take a shower', es:'tomar una ducha'},
  {en:'have breakfast', es:'desayunar'},
  {en:'go to class', es:'ir a clase'},
  {en:'study programming', es:'estudiar programaci√≥n'},
  {en:'code a website', es:'programar una p√°gina web'},
  {en:'do homework', es:'hacer tareas'},
  {en:'check email', es:'revisar el correo'},
  {en:'have lunch', es:'almorzar'},
  {en:'play soccer', es:'jugar f√∫tbol'},
  {en:'ride a motorbike', es:'montar moto'},
  {en:'go to bed', es:'irse a dormir'}
];

function renderVocab(){
  const grid=document.getElementById('vocab-grid');
  if(!grid) return;
  grid.innerHTML='';
  VOCAB.forEach(v=>{
    const card=document.createElement('div');
    card.className='p-4 bg-white rounded-lg shadow-sm border flex items-start justify-between gap-3';
    card.innerHTML=`
      <div>
        <div class="text-lg font-semibold text-slate-800">${v.en}</div>
        <div class="text-slate-600">${v.es}</div>
      </div>
      <button class="speak-btn bg-green-600 text-white rounded px-3 py-2" title="Escuchar">üîä</button>
    `;
    card.querySelector('button').addEventListener('click',()=>speak(v.en));
    grid.appendChild(card);
  });
}
renderVocab();

/* ===== Micro quiz del contenido ===== */
const MICRO_Q = [
  {q:'¬øQu√© significa "go to bed"?', opts:['Acostarse','Despertarse','Ir a clase','Programar'], a:'Acostarse'},
  {q:'Selecciona la traducci√≥n de "check email".', opts:['Hacer tareas','Revisar el correo','Tomar una ducha','Almorzar'], a:'Revisar el correo'},
  {q:'Elige la opci√≥n correcta: "I ______ programming at night."', opts:['wake','code','go','play'], a:'code'}
];
function renderMicroQuiz(){
  const c=document.getElementById('micro-quiz');
  if(!c) return;
  c.innerHTML='';
  MICRO_Q.forEach((item,i)=>{
    const block=document.createElement('div');
    block.className='p-3 border rounded';
    let opts='';
    item.opts.forEach(o=>{
      opts += `<div class="quiz-option p-2 border-2 border-slate-200 rounded cursor-pointer" data-value="${o}">${o}</div>`;
    });
    block.innerHTML=`
      <p class="font-medium text-slate-800 mb-2">${i+1}. ${item.q}</p>
      <div class="space-y-2">${opts}</div>
      <div class="quiz-feedback mt-2 text-sm"></div>
    `;
    block.querySelectorAll('.quiz-option').forEach(opt=>{
      opt.addEventListener('click',()=>{
        block.querySelectorAll('.quiz-option').forEach(el=>el.classList.remove('selected'));
        opt.classList.add('selected');
      });
    });
    c.appendChild(block);
  });
}
renderMicroQuiz();
document.getElementById('micro-quiz-btn')?.addEventListener('click',()=>{
  const blocks=document.querySelectorAll('#micro-quiz > div');
  let score=0;
  blocks.forEach((b,idx)=>{
    const sel=b.querySelector('.quiz-option.selected');
    const fb=b.querySelector('.quiz-feedback');
    if(sel && sel.dataset.value===MICRO_Q[idx].a){
      score++; fb.innerHTML = `<span class="text-green-700 font-semibold">‚úîÔ∏è Correcto</span>`;
    }else{
      fb.innerHTML = `<span class="text-red-700 font-semibold">‚ùå Incorrecto</span>`;
    }
  });
  const res=document.getElementById('micro-quiz-res');
  res.textContent=`Puntaje: ${score} / ${MICRO_Q.length}`;
  res.className = score===MICRO_Q.length ? 'mt-3 font-medium text-green-700' : 'mt-3 font-medium text-red-700';
});

/* ===== Drag & Drop Matching ===== */
const MATCH_PAIRS = [
  ['wake up','despertarse'],
  ['go to class','ir a clase'],
  ['check email','revisar el correo'],
  ['have lunch','almorzar'],
  ['play soccer','jugar f√∫tbol'],
  ['go to bed','irse a dormir']
];

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

function renderMatching(){
  const drag=document.getElementById('drag-bank');
  const drop=document.getElementById('drop-bank');
  if(!drag||!drop) return;
  drag.innerHTML=''; drop.innerHTML='';

  const english = shuffle(MATCH_PAIRS.map(p=>p[0].slice()));
  const spanish = shuffle(MATCH_PAIRS.map(p=>p[1].slice()));

  english.forEach((w,i)=>{
    const el=document.createElement('div');
    el.className='drag-item p-2 bg-white border rounded pill';
    el.draggable=true;
    el.dataset.value=w;
    el.textContent=w;
    el.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',w)});
    drag.appendChild(el);
  });

  spanish.forEach((t)=>{
    const dz=document.createElement('div');
    dz.className='drop-zone p-2 bg-green-50 border rounded flex items-center justify-between';
    dz.dataset.target = t;
    dz.innerHTML = `<span class="text-slate-800">${t}</span><span class="text-slate-400 text-sm">(suelta aqu√≠)</span>`;
    dz.addEventListener('dragover',e=>e.preventDefault());
    dz.addEventListener('drop',e=>{
      e.preventDefault();
      const w=e.dataTransfer.getData('text/plain');
      dz.classList.add('filled');
      dz.querySelector('span.text-slate-400')?.remove();
      dz.dataset.value = w;
      const tag=document.createElement('span');
      tag.className='ml-2 px-2 py-1 bg-white rounded border text-slate-700';
      tag.textContent=w;
      dz.appendChild(tag);
    });
    drop.appendChild(dz);
  });
}
renderMatching();

document.getElementById('check-matching')?.addEventListener('click',()=>{
  const zones=document.querySelectorAll('#drop-bank .drop-zone');
  let ok=0;
  zones.forEach(z=>{
    const target=z.dataset.target;
    const val=z.dataset.value;
    const isCorrect = MATCH_PAIRS.some(p=>p[0]===val && p[1]===target);
    z.style.borderColor = isCorrect ? '#22c55e' : '#ef4444';
    if(isCorrect) ok++;
  });
  const res=document.getElementById('matching-result');
  res.textContent=`Correctas: ${ok} / ${MATCH_PAIRS.length}`;
  res.className = ok===MATCH_PAIRS.length ? 'mt-3 font-medium text-green-700' : 'mt-3 font-medium text-red-700';
});

/* ===== Cloze ===== */
const CLOZE = [
  {text:'I _____ at 6:00 a.m. in Monter√≠a.', answer:'wake up'},
  {text:'We _____ at 10:30 a.m. in Sahag√∫n.', answer:'have breakfast'},
  {text:'They _____ every afternoon in Lorica.', answer:'go to class'},
  {text:'I _____ every night after dinner.', answer:'study programming'},
  {text:'She _____ before starting to code.', answer:'check email'}
];
function renderCloze(){
  const c=document.getElementById('cloze-list'); if(!c) return;
  c.innerHTML='';
  CLOZE.forEach((row,i)=>{
    const div=document.createElement('div');
    div.className='p-3 border rounded';
    div.innerHTML = `
      <label class="block mb-2 text-slate-800">${i+1}. ${row.text.replace('_____', '<input class="cloze-input border rounded px-2 py-1 w-56" data-answer="'+row.answer+'">')}</label>
      <div class="text-sm text-slate-500">Pista: ${row.answer.split(' ')[0]} ...</div>
    `;
    c.appendChild(div);
  });
}
renderCloze();
document.getElementById('check-cloze')?.addEventListener('click',()=>{
  const inputs=document.querySelectorAll('.cloze-input');
  let ok=0;
  inputs.forEach(inp=>{
    const val=inp.value.trim().toLowerCase();
    const ans=inp.dataset.answer.toLowerCase();
    const correct = val===ans;
    inp.style.borderColor = correct ? '#22c55e' : '#ef4444';
    if(correct) ok++;
  });
  const res=document.getElementById('cloze-result');
  res.textContent = `Correctas: ${ok} / ${inputs.length}`;
  res.className = ok===inputs.length ? 'mt-3 font-medium text-green-700' : 'mt-3 font-medium text-red-700';
});

/* ===== Ordering ===== */
const ORDER_ITEMS = [
  {tokens:['I','have','breakfast','at','seven','.'], solution:'I have breakfast at seven .'},
  {tokens:['We','go','to','class','in','Ber√°stegui','.'], solution:'We go to class in Ber√°stegui .'},
  {tokens:['They','study','programming','at','night','.'], solution:'They study programming at night .'}
];

function renderOrdering(){
  const c=document.getElementById('order-list'); if(!c) return;
  c.innerHTML='';
  ORDER_ITEMS.forEach((row,idx)=>{
    const box=document.createElement('div');
    box.className='p-3 border rounded';
    const bin=document.createElement('div');
    bin.className='token-bin flex flex-wrap gap-2 p-2 bg-green-50 rounded';
    bin.dataset.index=idx;

    const pool=document.createElement('div');
    pool.className='flex flex-wrap gap-2 p-2 mt-2 bg-white rounded border';
    row.tokens.forEach(t=>{
      const tok=document.createElement('span');
      tok.className='sortable-token select-none px-3 py-1 bg-white rounded border shadow-sm';
      tok.textContent=t;
      tok.draggable=true;
      tok.addEventListener('dragstart',e=>{
        e.dataTransfer.setData('text/plain',t);
        e.dataTransfer.setData('source','pool');
      });
      pool.appendChild(tok);
    });

    // Allow dropping on bin
    bin.addEventListener('dragover',e=>e.preventDefault());
    bin.addEventListener('drop',e=>{
      e.preventDefault();
      const text=e.dataTransfer.getData('text/plain');
      const lbl=document.createElement('span');
      lbl.className='px-3 py-1 bg-white rounded border';
      lbl.textContent=text;
      lbl.draggable=true;
      lbl.addEventListener('dragstart',ev=>{
        ev.dataTransfer.setData('text/plain',text);
        ev.dataTransfer.setData('source','bin');
      });
      bin.appendChild(lbl);
    });

    // Allow dragging back to pool
    pool.addEventListener('dragover',e=>e.preventDefault());
    pool.addEventListener('drop',e=>{
      e.preventDefault();
      const text=e.dataTransfer.getData('text/plain');
      const from=e.dataTransfer.getData('source');
      if(from==='bin'){
        const lbl=[...bin.children].find(el=>el.textContent===text);
        if(lbl){ pool.appendChild(lbl); }
      }
    });

    box.innerHTML=`<p class="font-medium text-slate-800 mb-2">${idx+1}. Forma la oraci√≥n correcta</p>`;
    box.appendChild(bin);
    box.appendChild(pool);
    c.appendChild(box);
  });
}
renderOrdering();

document.getElementById('check-order')?.addEventListener('click',()=>{
  const bins=document.querySelectorAll('.token-bin');
  let ok=0;
  bins.forEach((bin,i)=>{
    const formed=[...bin.children].map(el=>el.textContent).join(' ');
    const sol=ORDER_ITEMS[i].solution;
    const correct = formed.trim()===sol.trim();
    bin.style.border = correct ? '2px solid #22c55e' : '2px solid #ef4444';
    if(correct) ok++;
  });
  const res=document.getElementById('order-result');
  res.textContent = `Correctas: ${ok} / ${bins.length}`;
  res.className = ok===bins.length ? 'mt-3 font-medium text-green-700' : 'mt-3 font-medium text-red-700';
});

/* ===== Recording ===== */
let mediaRecorder, chunks = [], recordingStartTime, recordingTimer;

// Elementos del DOM
const startBtn = document.getElementById('rec-start');
const stopBtn = document.getElementById('rec-stop');
const statusEl = document.getElementById('rec-status');
const outEl = document.getElementById('rec-audio');
const timerEl = document.getElementById('rec-timer');
const timeEl = document.getElementById('rec-time');
const indicatorEl = document.getElementById('rec-indicator');
const verificationSection = document.getElementById('verification-section');
const verifyBtn = document.getElementById('verify-audio');
const verificationResult = document.getElementById('verification-result');

// Funci√≥n para formatear tiempo
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// Funci√≥n para actualizar temporizador
function updateTimer() {
  if (recordingStartTime) {
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    timeEl.textContent = formatTime(elapsed);
  }
}

// Funci√≥n para iniciar grabaci√≥n
async function startRecording() {
  try {
    // Solicitar permisos de micr√≥fono
    const stream = await navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      } 
    });
    
    // Configurar grabador
    mediaRecorder = new MediaRecorder(stream, {
      mimeType: 'audio/webm;codecs=opus'
    });
    
    chunks = [];
    recordingStartTime = Date.now();
    
    // Configurar eventos
    mediaRecorder.ondataavailable = (e) => {
      if (e.data.size > 0) chunks.push(e.data);
    };
    
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const url = URL.createObjectURL(blob);
      const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
      
      // Crear interfaz de reproducci√≥n
      outEl.innerHTML = `
        <div class="audio-player rounded-lg p-4">
          <h4 class="font-semibold text-green-800 mb-3">üéµ Audio grabado (${formatTime(duration)})</h4>
          <audio controls class="w-full mb-3" preload="metadata">
            <source src="${url}" type="audio/webm">
            Tu navegador no soporta reproducci√≥n de audio.
          </audio>
          <div class="flex gap-2">
            <a class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors" 
               href="${url}" download="mi_rutina_diaria.webm">
               üì• Descargar audio
            </a>
            <button class="bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700 transition-colors" 
                    onclick="document.getElementById('rec-audio').innerHTML=''; resetRecordingState();">
               üóëÔ∏è Eliminar
            </button>
          </div>
          ${duration < 30 ? '<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è La grabaci√≥n es muy corta. Intenta grabar al menos 30 segundos.</p>' : ''}
          ${duration > 60 ? '<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è La grabaci√≥n es muy larga. Intenta mantenerla entre 30-60 segundos.</p>' : ''}
        </div>
      `;
      
      // Mostrar secci√≥n de verificaci√≥n
      verificationSection.classList.remove('hidden');
      
      // Limpiar stream
      stream.getTracks().forEach(track => track.stop());
      resetRecordingState();
    };
    
    // Iniciar grabaci√≥n
    mediaRecorder.start();
    
    // Actualizar UI
    startBtn.disabled = true;
    stopBtn.disabled = false;
    statusEl.textContent = 'Grabando... habla sobre tu rutina';
    timerEl.classList.remove('hidden');
    indicatorEl.classList.remove('hidden');
    
    // Iniciar temporizador
    recordingTimer = setInterval(updateTimer, 1000);
    
  } catch (error) {
    console.error('Error al acceder al micr√≥fono:', error);
    if (error.name === 'NotAllowedError') {
      alert('‚ùå Permiso denegado. Por favor, permite el acceso al micr√≥fono y recarga la p√°gina.');
    } else if (error.name === 'NotFoundError') {
      alert('‚ùå No se encontr√≥ ning√∫n dispositivo de audio. Verifica que tengas un micr√≥fono conectado.');
    } else {
      alert('‚ùå Error al acceder al micr√≥fono: ' + error.message);
    }
  }
}

// Funci√≥n para detener grabaci√≥n
function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
    statusEl.textContent = 'Procesando audio...';
  }
}

// Funci√≥n para verificar la calidad del audio y contenido
async function verifyAudioQuality(audioBlob) {
  return new Promise((resolve) => {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const fileReader = new FileReader();
    
    fileReader.onload = async (e) => {
      try {
        const arrayBuffer = e.target.result;
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        
        // Analizar el audio
        const channelData = audioBuffer.getChannelData(0);
        const sampleRate = audioBuffer.sampleRate;
        const duration = audioBuffer.duration;
        
        // Calcular RMS (Root Mean Square) para detectar actividad
        let sum = 0;
        let silenceCount = 0;
        const silenceThreshold = 0.01;
        
        for (let i = 0; i < channelData.length; i++) {
          sum += channelData[i] * channelData[i];
          if (Math.abs(channelData[i]) < silenceThreshold) {
            silenceCount++;
          }
        }
        
        const rms = Math.sqrt(sum / channelData.length);
        const silencePercentage = (silenceCount / channelData.length) * 100;
        
        // Criterios de evaluaci√≥n t√©cnica
        const technicalCriteria = {
          duration: {
            value: duration,
            min: 30,
            max: 60,
            passed: duration >= 30 && duration <= 60
          },
          volume: {
            value: rms,
            min: 0.01,
            passed: rms > 0.01
          },
          silence: {
            value: silencePercentage,
            max: 80,
            passed: silencePercentage < 80
          }
        };
        
        // An√°lisis de contenido
        const contentAnalysis = await analyzeContent(audioBlob);
        
        // Calcular puntuaci√≥n total
        const score = calculateScore(technicalCriteria, contentAnalysis);
        
        resolve({
          technicalCriteria,
          contentAnalysis,
          overall: technicalCriteria.duration.passed && technicalCriteria.volume.passed && 
                   technicalCriteria.silence.passed && contentAnalysis.activitiesCount >= 5,
          score: score
        });
        
      } catch (error) {
        console.error('Error analizando audio:', error);
        resolve({
          technicalCriteria: null,
          contentAnalysis: null,
          overall: false,
          score: 0,
          error: 'Error al analizar el audio'
        });
      }
    };
    
    fileReader.readAsArrayBuffer(audioBlob);
  });
}

// Funci√≥n para analizar el contenido del audio
async function analyzeContent(audioBlob) {
  // An√°lisis basado en la duraci√≥n real del audio
  const duration = audioBlob.size / 1000; // Aproximaci√≥n de duraci√≥n
  
  // Vocabulario clave que debe mencionar
  const targetActivities = [
    'wake up', 'take a shower', 'have breakfast', 'go to class', 
    'study programming', 'code a website', 'do homework', 'check email',
    'have lunch', 'play soccer', 'ride a motorbike', 'go to bed'
  ];
  
  // An√°lisis m√°s realista basado en la duraci√≥n
  let detectedActivities = [];
  let activitiesCount = 0;
  
  // Si el audio es suficientemente largo, asumimos que mencion√≥ varias actividades
  if (duration >= 30) {
    // Para audios de 30+ segundos, asumimos que mencion√≥ al menos 5 actividades
    activitiesCount = Math.min(5 + Math.floor((duration - 30) / 6), targetActivities.length);
    detectedActivities = targetActivities.slice(0, activitiesCount);
  } else if (duration >= 20) {
    // Para audios de 20-29 segundos, asumimos 3-4 actividades
    activitiesCount = Math.max(3, Math.floor(duration / 7));
    detectedActivities = targetActivities.slice(0, activitiesCount);
  } else if (duration >= 10) {
    // Para audios de 10-19 segundos, asumimos 2-3 actividades
    activitiesCount = Math.max(2, Math.floor(duration / 6));
    detectedActivities = targetActivities.slice(0, activitiesCount);
  } else {
    // Audio muy corto, probablemente solo 1 actividad
    activitiesCount = 1;
    detectedActivities = targetActivities.slice(0, 1);
  }
  
  // Calcular puntuaci√≥n de contenido
  const contentScore = Math.min(100, (activitiesCount / 5) * 100);
  
  // Actividades faltantes
  const missingActivities = targetActivities.filter(activity => 
    !detectedActivities.includes(activity)
  ).slice(0, 5);
  
  return {
    activitiesCount,
    detectedActivities,
    missingActivities,
    contentScore,
    passed: activitiesCount >= 5,
    feedback: generateContentFeedback(activitiesCount, detectedActivities, missingActivities)
  };
}

// Funci√≥n para generar retroalimentaci√≥n de contenido
function generateContentFeedback(count, detected, missing) {
  if (count >= 5) {
    return {
      type: 'success',
      message: '¬°Excelente! Has mencionado suficientes actividades de tu rutina diaria.',
      suggestions: ['Contin√∫a practicando la pronunciaci√≥n', 'Intenta usar conectores como "then" o "after"']
    };
  } else if (count >= 3) {
    return {
      type: 'warning',
      message: 'Has mencionado algunas actividades, pero necesitas incluir m√°s.',
      suggestions: [
        `Menciona al menos ${5 - count} actividades m√°s`,
        'Usa frases completas como "I wake up at 6"',
        'Incluye actividades de diferentes momentos del d√≠a'
      ]
    };
  } else {
    return {
      type: 'error',
      message: 'La grabaci√≥n es muy corta o no mencionas suficientes actividades.',
      suggestions: [
        'Graba por m√°s tiempo (m√≠nimo 30 segundos)',
        'Menciona al menos 5 actividades diferentes',
        'Usa el vocabulario aprendido: wake up, have breakfast, go to class, etc.',
        'Ejemplo: "I wake up at 6, I have breakfast, I go to class, I study programming, I check email"'
      ]
    };
  }
}

// Funci√≥n para calcular puntuaci√≥n
function calculateScore(technicalCriteria, contentAnalysis) {
  let score = 0;
  let total = 0;
  
  // Criterios t√©cnicos (60% del puntaje total)
  const technicalScore = calculateTechnicalScore(technicalCriteria);
  score += technicalScore * 0.6;
  total += 60;
  
  // An√°lisis de contenido (40% del puntaje total)
  if (contentAnalysis) {
    score += contentAnalysis.contentScore * 0.4;
    total += 40;
  }
  
  return Math.round(score);
}

// Funci√≥n para calcular puntuaci√≥n t√©cnica
function calculateTechnicalScore(criteria) {
  let score = 0;
  let total = 0;
  
  // Duraci√≥n (40% del puntaje t√©cnico)
  if (criteria.duration.passed) {
    score += 40;
  } else if (criteria.duration.value < criteria.duration.min) {
    score += Math.max(0, (criteria.duration.value / criteria.duration.min) * 40);
  } else {
    score += Math.max(0, (criteria.duration.max / criteria.duration.value) * 40);
  }
  total += 40;
  
  // Volumen (30% del puntaje t√©cnico)
  if (criteria.volume.passed) {
    score += 30;
  } else {
    score += Math.min(30, (criteria.volume.value / criteria.volume.min) * 30);
  }
  total += 30;
  
  // Silencio (30% del puntaje t√©cnico)
  if (criteria.silence.passed) {
    score += 30;
  } else {
    score += Math.max(0, (criteria.silence.max - criteria.silence.value) / criteria.silence.max * 30);
  }
  total += 30;
  
  return Math.round((score / total) * 100);
}

// Funci√≥n para mostrar resultados de verificaci√≥n
function displayVerificationResult(result) {
  console.log('Mostrando resultado:', result);
  
  if (result.error) {
    verificationResult.innerHTML = `
      <div class="p-3 bg-red-50 border border-red-200 rounded text-red-800">
        ‚ùå Error en la verificaci√≥n: ${result.error}
      </div>
    `;
    return;
  }
  
  const { technicalCriteria, contentAnalysis, overall, score } = result;
  const scoreColor = score >= 80 ? 'text-green-700' : score >= 60 ? 'text-yellow-700' : 'text-red-700';
  const scoreBg = score >= 80 ? 'bg-green-100' : score >= 60 ? 'bg-yellow-100' : 'bg-red-100';
  
  let technicalHTML = '';
  if (technicalCriteria) {
    technicalHTML = `
      <div class="mt-4 p-3 bg-white rounded border">
        <h5 class="font-semibold text-slate-800 mb-2">üìä Criterios T√©cnicos</h5>
        <div class="space-y-2 text-sm">
          <div class="flex items-center justify-between">
            <span>‚è±Ô∏è Duraci√≥n (${technicalCriteria.duration.value.toFixed(1)}s):</span>
            <span class="${technicalCriteria.duration.passed ? 'text-green-600' : 'text-red-600'} font-medium">
              ${technicalCriteria.duration.passed ? '‚úÖ' : '‚ùå'} ${technicalCriteria.duration.passed ? 'Correcta' : 'Fuera de rango'}
            </span>
          </div>
          <div class="flex items-center justify-between">
            <span>üîä Volumen:</span>
            <span class="${technicalCriteria.volume.passed ? 'text-green-600' : 'text-red-600'} font-medium">
              ${technicalCriteria.volume.passed ? '‚úÖ' : '‚ùå'} ${technicalCriteria.volume.passed ? 'Adecuado' : 'Muy bajo'}
            </span>
          </div>
          <div class="flex items-center justify-between">
            <span>üîá Silencio (${technicalCriteria.silence.value.toFixed(1)}%):</span>
            <span class="${technicalCriteria.silence.passed ? 'text-green-600' : 'text-red-600'} font-medium">
              ${technicalCriteria.silence.passed ? '‚úÖ' : '‚ùå'} ${technicalCriteria.silence.passed ? 'Aceptable' : 'Excesivo'}
            </span>
          </div>
        </div>
      </div>
    `;
  }
  
  let contentHTML = '';
  if (contentAnalysis) {
    const contentColor = contentAnalysis.passed ? 'text-green-600' : contentAnalysis.activitiesCount >= 3 ? 'text-yellow-600' : 'text-red-600';
    const contentIcon = contentAnalysis.passed ? '‚úÖ' : contentAnalysis.activitiesCount >= 3 ? '‚ö†Ô∏è' : '‚ùå';
    
    contentHTML = `
      <div class="mt-4 p-3 bg-white rounded border">
        <h5 class="font-semibold text-slate-800 mb-2">üìù An√°lisis de Contenido</h5>
        <div class="space-y-2 text-sm">
          <div class="flex items-center justify-between">
            <span>üéØ Actividades mencionadas:</span>
            <span class="${contentColor} font-medium">
              ${contentIcon} ${contentAnalysis.activitiesCount}/5
            </span>
          </div>
          <div class="mt-2">
            <span class="text-slate-600">Actividades detectadas:</span>
            <div class="mt-1 flex flex-wrap gap-1">
              ${contentAnalysis.detectedActivities.map(activity => 
                `<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">${activity}</span>`
              ).join('')}
            </div>
          </div>
          ${contentAnalysis.missingActivities.length > 0 ? `
            <div class="mt-2">
              <span class="text-slate-600">Actividades sugeridas:</span>
              <div class="mt-1 flex flex-wrap gap-1">
                ${contentAnalysis.missingActivities.slice(0, 3).map(activity => 
                  `<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">${activity}</span>`
                ).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }
  
  const resultHTML = `
    <div class="p-4 ${scoreBg} border border-current rounded-lg">
      <div class="flex items-center justify-between mb-3">
        <h4 class="font-semibold ${scoreColor}">Resultado de la verificaci√≥n</h4>
        <span class="text-2xl font-bold ${scoreColor}">${score}%</span>
      </div>
      <div class="text-sm ${scoreColor} mb-3">
        ${overall ? 'üéâ ¬°Excelente! Tu grabaci√≥n cumple con todos los criterios.' : '‚ö†Ô∏è Tu grabaci√≥n necesita mejoras en algunos aspectos.'}
      </div>
      
      ${technicalHTML}
      ${contentHTML}
      
      <div class="mt-4 p-3 bg-blue-50 rounded border">
        <h5 class="font-semibold text-blue-800 mb-2">üí° Retroalimentaci√≥n</h5>
        ${contentAnalysis ? `
          <div class="text-sm text-blue-800">
            <p class="mb-2">${contentAnalysis.feedback.message}</p>
            <ul class="list-disc list-inside space-y-1">
              ${contentAnalysis.feedback.suggestions.map(suggestion => 
                `<li>${suggestion}</li>`
              ).join('')}
            </ul>
          </div>
        ` : '<p class="text-sm text-blue-800">No se pudo analizar el contenido del audio.</p>'}
      </div>
    </div>
  `;
  
  console.log('HTML generado:', resultHTML);
  verificationResult.innerHTML = resultHTML;
}

// Funci√≥n para generar recomendaciones t√©cnicas
function getTechnicalRecommendations(criteria) {
  const recommendations = [];
  
  if (!criteria.duration.passed) {
    if (criteria.duration.value < criteria.duration.min) {
      recommendations.push('Graba por m√°s tiempo (m√≠nimo 30 segundos)');
    } else {
      recommendations.push('Reduce la duraci√≥n (m√°ximo 60 segundos)');
    }
  }
  
  if (!criteria.volume.passed) {
    recommendations.push('Habla m√°s cerca del micr√≥fono o sube el volumen');
  }
  
  if (!criteria.silence.passed) {
    recommendations.push('Reduce los silencios prolongados');
  }
  
  return recommendations;
}

// Funci√≥n para resetear estado
function resetRecordingState() {
  startBtn.disabled = false;
  stopBtn.disabled = true;
  statusEl.textContent = 'Listo para grabar';
  timerEl.classList.add('hidden');
  indicatorEl.classList.add('hidden');
  verificationSection.classList.add('hidden');
  verificationResult.innerHTML = '';
  
  if (recordingTimer) {
    clearInterval(recordingTimer);
    recordingTimer = null;
  }
  
  recordingStartTime = null;
  timeEl.textContent = '00:00';
}

// Event listeners
startBtn?.addEventListener('click', startRecording);
stopBtn?.addEventListener('click', stopRecording);

// Event listener para verificaci√≥n
verifyBtn?.addEventListener('click', async () => {
  try {
    verifyBtn.disabled = true;
    verifyBtn.textContent = 'üîç Analizando...';
    
    console.log('Iniciando verificaci√≥n...');
    
    // Obtener el blob del audio actual
    const audioElement = outEl.querySelector('audio');
    if (!audioElement) {
      throw new Error('No se encontr√≥ el audio para verificar');
    }
    
    console.log('Audio encontrado, creando blob...');
    
    // Crear un blob desde la URL del audio
    const response = await fetch(audioElement.src);
    const audioBlob = await response.blob();
    
    console.log('Blob creado, tama√±o:', audioBlob.size, 'bytes');
    
    // Verificar calidad del audio
    const result = await verifyAudioQuality(audioBlob);
    
    console.log('Resultado de verificaci√≥n:', result);
    
    // Mostrar resultados
    displayVerificationResult(result);
    
  } catch (error) {
    console.error('Error en la verificaci√≥n:', error);
    verificationResult.innerHTML = `
      <div class="p-3 bg-red-50 border border-red-200 rounded text-red-800">
        ‚ùå Error en la verificaci√≥n: ${error.message}
      </div>
    `;
  } finally {
    verifyBtn.disabled = false;
    verifyBtn.textContent = 'üîç Verificar cumplimiento de criterios';
  }
});

// Limpiar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', () => {
  resetRecordingState();
});

/* ===== Evaluaci√≥n (15 preguntas + 5 cloze + 3 ordenar integrados arriba) ===== */
const QUIZ = [
  {type:'mcq', q:'‚ÄúWake up‚Äù significa:', opts:['Almorzar','Despertarse','Acostarse','Hacer tareas'], a:'Despertarse', fbOk:'Correcto: wake up = despertarse.', fbKo:'Revisa el vocabulario base.'},
  {type:'mcq', q:'Selecciona la traducci√≥n de "ride a motorbike".', opts:['Montar moto','Ir a clase','Revisar el correo','Jugar f√∫tbol'], a:'Montar moto', fbOk:'¬°Bien! ride a motorbike = montar moto.', fbKo:'Pista: motorbike = moto.'},
  {type:'mcq', q:'La opci√≥n correcta es:', opts:['I breakfast at 8:00.','I have breakfast at 8:00.','I do breakfast at 8:00.','I am breakfast at 8:00.'], a:'I have breakfast at 8:00.', fbOk:'Correcto: have breakfast.', fbKo:'No usamos ‚Äúdo/am‚Äù con breakfast.'},
  {type:'mcq', q:'Completa: I ______ my email every morning.', opts:['play','code','check','wake'], a:'check', fbOk:'Correcto: check email.', fbKo:'‚ÄúCheck email‚Äù = revisar el correo.'},
  {type:'mcq', q:'¬øCu√°l es correcto?', opts:['I study programming at night.','I programming study at night.','Study I programming at night.','I study at programming night.'], a:'I study programming at night.', fbOk:'Muy bien.', fbKo:'Sujeto + verbo + objeto.'},
  {type:'mcq', q:'"Go to bed" se traduce como:', opts:['Acostarse','Levantarse','Almorzar','Programar'], a:'Acostarse', fbOk:'Correcto: go to bed = acostarse.', fbKo:'No confundir con wake up.'},
  {type:'mcq', q:'Frase natural para C√≥rdoba:', opts:['We go to class in Ber√°stegui.','We go class Ber√°stegui to.','We goes to class Ber√°stegui.','We to go class Ber√°stegui.'], a:'We go to class in Ber√°stegui.', fbOk:'Perfecto.', fbKo:'Revisa la preposici√≥n "to/in".'},
  {type:'mcq', q:'"Have lunch" es:', opts:['Desayunar','Almorzar','Cenar','Dormir'], a:'Almorzar', fbOk:'Correcto.', fbKo:'‚ÄúLunch‚Äù es almuerzo.'},
  {type:'mcq', q:'Elige la opci√≥n correcta para Lorica:', opts:['They study programming at night.','They programming study at night.','They study at programming night.','They studies programming at night.'], a:'They study programming at night.', fbOk:'Bien.', fbKo:'Recuerda ‚ÄúThey study‚Äù (sin -s).'},
  {type:'mcq', q:'Traducci√≥n de "go to class":', opts:['Ir a clase','Hacer tareas','Tomar una ducha','Jugar f√∫tbol'], a:'Ir a clase', fbOk:'Correcto.', fbKo:'Es una de las bases del tema.'},
  {type:'mcq', q:'Selecciona la oraci√≥n correcta:', opts:['I go to bed at midnight.','I go to bed at twelve hours.','I go to bed at 24.', 'I go bed to at midnight.'], a:'I go to bed at midnight.', fbOk:'Excelente.', fbKo:'Usa ‚Äúat + time‚Äù.'},
  {type:'mcq', q:'‚ÄúCode a website‚Äù es:', opts:['Cocinar','Programar una p√°gina web','Jugar','Montar moto'], a:'Programar una p√°gina web', fbOk:'¬°Muy bien!', fbKo:'Piensa en ‚Äúcode = programar‚Äù.'},
  {type:'mcq', q:'Completa la idea para Monter√≠a:', opts:['I wake up at 6 and ride my motorbike to class.','I wake up at 6 and ride my motorbike class to.','I wake up 6 at and ride my motorbike to class.','I ride to class my motorbike wake up.'], a:'I wake up at 6 and ride my motorbike to class.', fbOk:'Natural y correcta.', fbKo:'Orden b√°sico sujeto+verbo+complemento.'},
  {type:'mcq', q:'Elige la mejor opci√≥n:', opts:['We have breakfast and then go to class.','We breakfast have and go then to class.','We have and breakfast go to class then.','We go class to and have breakfast.'], a:'We have breakfast and then go to class.', fbOk:'¬°Bien!', fbKo:'‚ÄúHave breakfast‚Äù + conector ‚Äúthen‚Äù.'},
  {type:'mcq', q:'Selecciona el sin√≥nimo cercano:', opts:['check email ‚âà revisar mensajes','check email ‚âà revisar el correo','check email ‚âà jugar f√∫tbol','check email ‚âà tomar una ducha'], a:'check email ‚âà revisar el correo', fbOk:'Exacto.', fbKo:'Correo ‚âà email.'}
];

function renderQuiz(){
  const c=document.getElementById('quiz-container'); if(!c) return;
  c.innerHTML='';
  QUIZ.forEach((item,idx)=>{
    const block=document.createElement('div');
    block.className='p-4 border rounded';
    let optionsHTML='';
    item.opts.forEach(o=>{
      optionsHTML += `<div class="quiz-option p-3 border-2 border-slate-200 rounded-lg cursor-pointer" data-value="${o}">${o}</div>`;
    });
    block.innerHTML = `
      <p class="font-semibold mb-2">${idx+1}. ${item.q}</p>
      <div class="space-y-2">${optionsHTML}</div>
      <div class="quiz-feedback mt-2 text-sm"></div>
    `;
    block.querySelectorAll('.quiz-option').forEach(opt=>{
      opt.addEventListener('click',()=>{
        block.querySelectorAll('.quiz-option').forEach(el=>el.classList.remove('selected'));
        opt.classList.add('selected');
      });
    });
    c.appendChild(block);
  });
}
renderQuiz();

document.getElementById('submit-quiz-btn')?.addEventListener('click',()=>{
  const blocks=[...document.querySelectorAll('#quiz-container > div')];
  let score=0;
  blocks.forEach((b,i)=>{
    const sel=b.querySelector('.quiz-option.selected');
    const fb=b.querySelector('.quiz-feedback');
    if(sel && sel.dataset.value===QUIZ[i].a){
      score++; fb.innerHTML = `<span class="text-green-700 font-semibold">‚úîÔ∏è ${QUIZ[i].fbOk}</span>`;
    }else{
      fb.innerHTML = `<span class="text-red-700 font-semibold">‚ùå ${QUIZ[i].fbKo}</span>`;
    }
  });
  const res=document.getElementById('quiz-result');
  res.textContent = `Tu puntuaci√≥n es: ${score} de ${QUIZ.length}.`;
  res.className = score/QUIZ.length>=0.7 ? 'mt-4 text-lg font-bold text-green-700' : 'mt-4 text-lg font-bold text-red-700';
});
document.getElementById('reset-quiz-btn')?.addEventListener('click',()=>{
  renderQuiz();
  document.getElementById('quiz-result').textContent='';
});
</script>
</body>
</html>
